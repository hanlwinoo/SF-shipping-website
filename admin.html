<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF Shipping - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* ===== Base Styles ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* ===== Header Styles ===== */
        header { background: linear-gradient(to right, #1a2980, #26d0ce); color: white; padding: 30px 40px; text-align: center; }
        .logo-container { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px; }
        .sf-logo { width: 80px; height: 80px; border-radius: 50%; object-fit: contain; border: 3px solid white; background: white; padding: 5px; cursor: pointer; }
        h1 { font-size: 2.8rem; font-weight: 700; letter-spacing: 1px; }
        .tagline { font-size: 1.2rem; opacity: 0.9; margin-top: 10px; }
        
        /* ===== Admin Container ===== */
        .admin-container { padding: 30px 40px 40px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eee; }
        .admin-header h2 { color: #1a2980; margin: 0; font-size: 1.8rem; display: flex; align-items: center; gap: 10px; }
        
        /* ===== Tabs ===== */
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; font-size: 16px; font-weight: 600; color: #666; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .tab-btn.active { color: #1a2980; border-bottom-color: #1a2980; }
        .tab-btn:hover:not(.active) { color: #26d0ce; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-content h3 { color: #1a2980; margin-bottom: 20px; font-size: 1.5rem; }
        
        /* ===== Shipping Form ===== */
        .shipping-form { background: #f8f9fa; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .shipping-form h4 { color: #1a2980; margin: 25px 0 15px; font-size: 1.2rem; border-bottom: 2px solid #eaeaea; padding-bottom: 8px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; display: flex; align-items: center; gap: 8px; }
        input, textarea, select { width: 100%; padding: 14px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: 0.3s; }
        input:focus, textarea:focus, select:focus { border-color: #26d0ce; outline: none; box-shadow: 0 0 0 3px rgba(38,208,206,0.2); }
        .form-actions { display: flex; gap: 15px; margin-top: 30px; }
        
        /* ===== Button Styles ===== */
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(to right, #1a2980, #26d0ce); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-sm { padding: 8px 16px; font-size: 14px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        /* ===== Table Styles ===== */
        .table-responsive { overflow-x: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-top: 20px; }
        .shipping-table { width: 100%; border-collapse: collapse; background: white; min-width: 1000px; }
        .shipping-table th { background: linear-gradient(to right, #1a2980, #26d0ce); color: white; padding: 15px; text-align: left; font-weight: 600; white-space: nowrap; }
        .shipping-table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .shipping-table tr:hover { background-color: #f8f9fa; }
        
        /* ===== Status Badges ===== */
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-in-transit { background: #cce5ff; color: #004085; }
        .status-customs { background: #d4edda; color: #155724; }
        .status-delivered { background: #d1ecf1; color: #0c5460; }
        
        /* ===== Action Buttons ===== */
        .action-buttons { display: flex; flex-direction: column; gap: 8px; min-width: 140px; }
        
        /* ===== QR Modal Styles ===== */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 0; width: 90%; max-width: 450px; border-radius: 10px; box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .modal-header { background: linear-gradient(to right, #1a2980, #26d0ce); color: white; padding: 20px 30px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { color: white; margin: 0; font-size: 1.5rem; }
        .close { font-size: 28px; cursor: pointer; transition: 0.3s; }
        .close:hover { color: #ffeb3b; }
        .modal-body { padding: 30px; }
        
        /* ===== QR Code Specific ===== */
        .qr-code-container { text-align: center; padding: 20px; background: white; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eaeaea; }
        .qr-code-display { width: 200px; height: 200px; margin: 0 auto 15px; background: white; padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
        .qr-info { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .qr-info p { margin: 8px 0; color: #333; }
        
        /* ===== Loading Spinner ===== */
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1a2980; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ===== Flag Icons ===== */
        .flag-icon { font-size: 1.2rem; margin-right: 8px; }
        
        /* ===== Hint Text ===== */
        .hint { display: block; margin-top: 5px; color: #666; font-size: 0.9rem; font-style: italic; }
        
        /* ===== Responsive Design ===== */
        @media (max-width: 768px) {
            .container { border-radius: 0; margin: -20px; }
            header { padding: 20px; }
            h1 { font-size: 2rem; }
            .admin-container { padding: 20px; }
            .admin-header { flex-direction: column; gap: 15px; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .form-actions { flex-direction: column; }
            .btn { width: 100%; }
            .admin-tabs { flex-direction: column; }
            .tab-btn { width: 100%; justify-content: center; }
            .shipping-form { padding: 20px; }
            .shipping-table { font-size: 14px; }
            .action-buttons { min-width: 120px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Logo_of_SF_Express.svg/1280px-Logo_of_SF_Express.svg.png" 
                     alt="SF Shipping Logo" class="sf-logo" onclick="window.location.href='index.html'">
                <h1>SF Shipping Admin</h1>
            </div>
            <p class="tagline">Management Portal - Real-time Shipment Tracking</p>
        </header>

        <div class="admin-container">
            <div class="admin-header">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <button id="logoutBtn" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn active" id="addShippingTab">
                    <i class="fas fa-plus-circle"></i> Add New Shipping
                </button>
                <button class="tab-btn" id="manageShippingTab">
                    <i class="fas fa-list-alt"></i> Manage Shipments
                </button>
            </div>

            <div class="tab-content active" id="addShippingContent">
                <form id="shippingForm" class="shipping-form">
                    <h3><i class="fas fa-box"></i> Create New Shipment</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="senderName"><i class="fas fa-user"></i> Sender Name *</label>
                            <input type="text" id="senderName" required placeholder="Enter sender's full name">
                        </div>
                    </div>

                    <h4><i class="fas fa-user-check"></i> Receiver Information</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="receiverName">Full Name *</label>
                            <input type="text" id="receiverName" required placeholder="Enter receiver's full name">
                        </div>
                        <div class="form-group">
                            <label for="receiverPhone">Phone Number *</label>
                            <input type="tel" id="receiverPhone" required placeholder="Enter receiver's phone number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="receiverAddress">Full Address *</label>
                            <textarea id="receiverAddress" required rows="3" placeholder="Enter complete delivery address including postal code"></textarea>
                        </div>
                    </div>

                    <h4><i class="fas fa-route"></i> Shipping Route</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="origin">Shipping From *</label>
                            <select id="origin" required>
                                <option value="">Select origin country</option>
                                <option value="Malaysia">Malaysia</option>
                                <option value="Singapore">Singapore</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="destination">Shipping To *</label>
                            <select id="destination" required>
                                <option value="">Select destination country</option>
                                <option value="Australia">Australia</option>
                                <option value="Canada">Canada</option>
                                <option value="USA">United States</option>
                                <option value="New Zealand">New Zealand</option>
                                <option value="Philippines">Philippines</option>
                                <option value="Vietnam">Vietnam</option>
                                <option value="Thailand">Thailand</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Create Shipment
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> Clear Form
                        </button>
                    </div>
                    
                    <div class="hint" style="margin-top: 20px; background: #e8f4fc; padding: 15px; border-radius: 8px;">
                        <i class="fas fa-qrcode" style="color: #2196F3;"></i> After creating shipment, you can generate QR code from Manage Shipments tab for easy tracking.
                    </div>
                </form>
            </div>

            <div class="tab-content" id="manageShippingContent">
                <h3><i class="fas fa-boxes"></i> All Shipments</h3>
                <p style="color: #666; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <i class="fas fa-sync-alt"></i> Updates automatically every 30 seconds. 
                    <i class="fas fa-edit"></i> Click "Update" to change shipment status. 
                    <i class="fas fa-qrcode" style="color: #28a745;"></i> Click "Generate QR" for QR code. 
                    <i class="fas fa-trash" style="color: #dc3545;"></i> Click "Delete" to remove shipment.
                </p>
                
                <div class="table-responsive">
                    <table class="shipping-table">
                        <thead>
                            <tr>
                                <th>Tracking Details</th>
                                <th>Sender</th>
                                <th>Receiver</th>
                                <th>Phone</th>
                                <th>Origin</th>
                                <th>Destination</th>
                                <th>Status</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shippingTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px;">
                                    <div class="loading" style="margin: 0 auto;"></div>
                                    <p style="margin-top: 10px; color: #666;">Loading shipments...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
        // Check authentication
        if (localStorage.getItem('sfAdminAuth') !== 'true') {
            window.location.href = 'index.html';
        }

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD123abc456def789ghi",
            authDomain: "logstic-system.firebaseapp.com",
            databaseURL: "https://logstic-system-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "logstic-system",
            storageBucket: "logstic-system.appspot.com",
            messagingSenderId: "929186977018",
            appId: "1:929186977018:web:342a2cf9454f03c8e0a543"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const shippingForm = document.getElementById('shippingForm');
        const shippingTableBody = document.getElementById('shippingTableBody');
        const addShippingTab = document.getElementById('addShippingTab');
        const manageShippingTab = document.getElementById('manageShippingTab');
        const addShippingContent = document.getElementById('addShippingContent');
        const manageShippingContent = document.getElementById('manageShippingContent');
        const logoutBtn = document.getElementById('logoutBtn');

        // ==================== QR CODE URL GENERATION ====================
        // Get the correct website URL for QR codes
        function getWebsiteURL() {
            const currentUrl = window.location.href;
            
            // Check if we're on GitHub Pages
            if (currentUrl.includes('github.io')) {
                // Extract username and repository name
                const urlParts = currentUrl.split('/');
                const username = urlParts[2].split('.')[0]; // e.g., "hlaingwinoo"
                return `https://${username}.github.io/sf-shipping/`;
            } else {
                // Local development
                return window.location.origin + '/';
            }
        }

        // Generate tracking number
        function generateTrackingNumber() {
            const randomDigits = Math.floor(100000000 + Math.random() * 900000000);
            return 'SF' + randomDigits;
        }

        // Generate confirmation code
        function generateConfirmationCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Country flag emojis
        function getCountryFlag(country) {
            if (!country) return 'üè≥Ô∏è';
            const flags = {
                'Malaysia': 'üá≤üáæ',
                'Singapore': 'üá∏üá¨',
                'Australia': 'üá¶üá∫',
                'Canada': 'üá®üá¶',
                'USA': 'üá∫üá∏',
                'United States': 'üá∫üá∏',
                'New Zealand': 'üá≥üáø',
                'Philippines': 'üáµüá≠',
                'Vietnam': 'üáªüá≥',
                'Thailand': 'üáπüá≠'
            };
            return flags[country] || 'üè≥Ô∏è';
        }

        // Status badge class
        function getStatusClass(status) {
            if (!status) return 'status-pending';
            if (status.includes('Pending')) return 'status-pending';
            if (status.includes('Transit')) return 'status-in-transit';
            if (status.includes('Customs')) return 'status-customs';
            if (status.includes('Delivered')) return 'status-delivered';
            return 'status-pending';
        }

        // Add new shipping
        async function addShipping(event) {
            event.preventDefault();
            
            const senderName = document.getElementById('senderName').value.trim();
            const receiverName = document.getElementById('receiverName').value.trim();
            const receiverAddress = document.getElementById('receiverAddress').value.trim();
            const receiverPhone = document.getElementById('receiverPhone').value.trim();
            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;

            // Validation
            if (!senderName || !receiverName || !receiverAddress || !receiverPhone || !origin || !destination) {
                alert('Please fill in all required fields.');
                return;
            }

            if (origin === destination) {
                alert('Origin and destination cannot be the same.');
                return;
            }

            const trackingNumber = generateTrackingNumber();
            const confirmationCode = generateConfirmationCode();
            const timestamp = new Date().toISOString();

            // Determine if customs clearance is needed
            const aseanCountries = ['thailand', 'vietnam', 'philippines', 'singapore', 'malaysia'];
            const requiresCustoms = !(aseanCountries.includes(origin.toLowerCase()) && 
                                     aseanCountries.includes(destination.toLowerCase()));

            const shipmentData = {
                trackingNumber: trackingNumber,
                confirmationCode: confirmationCode,
                sender: { 
                    name: senderName 
                },
                receiver: {
                    name: receiverName,
                    address: receiverAddress,
                    phone: receiverPhone
                },
                origin: origin,
                destination: destination,
                status: 'Pending Pickup',
                createdAt: timestamp,
                updatedAt: timestamp,
                requiresCustoms: requiresCustoms,
                trackingHistory: [{
                    date: new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }),
                    description: 'Shipment created and registered in system',
                    location: origin
                }]
            };

            try {
                const submitBtn = shippingForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
                submitBtn.disabled = true;

                await database.ref('shipments/' + trackingNumber).set(shipmentData);
                
                // Clear form
                shippingForm.reset();
                
                // Show success message with QR option
                const showQR = confirm(`‚úÖ Shipment added successfully!\n\nüì¶ Tracking Number: ${trackingNumber}\nüîë Confirmation Code: ${confirmationCode}\n\nDo you want to generate QR code for this shipment?`);
                
                if (showQR) {
                    generateQRCodeForAdmin(trackingNumber, confirmationCode);
                }
                
                // Refresh table if we're on manage tab
                if (manageShippingTab.classList.contains('active')) {
                    await loadShipments();
                }
                
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                console.error('Error adding shipment:', error);
                alert('‚ùå Error adding shipment. Please try again.');
                const submitBtn = shippingForm.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Create Shipment';
                submitBtn.disabled = false;
            }
        }

        // Load shipments for management
        async function loadShipments() {
            try {
                const snapshot = await database.ref('shipments').once('value');
                const shipments = snapshot.val();
                
                shippingTableBody.innerHTML = '';
                
                if (!shipments) {
                    shippingTableBody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p>No shipments found</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Convert object to array and sort by date (newest first)
                const shipmentsArray = Object.entries(shipments).map(([trackingNumber, shipment]) => ({
                    trackingNumber,
                    ...shipment
                })).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                shipmentsArray.forEach((shipment, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <strong style="color: #1a2980;">${shipment.trackingNumber}</strong>
                            <br><small style="color: #666;">Code: ${shipment.confirmationCode}</small>
                        </td>
                        <td>${shipment.sender?.name || 'N/A'}</td>
                        <td>
                            <strong>${shipment.receiver?.name || 'N/A'}</strong>
                            <br><small>${shipment.receiver?.phone || ''}</small>
                        </td>
                        <td>${shipment.receiver?.phone || 'N/A'}</td>
                        <td>
                            <span class="flag-icon">${getCountryFlag(shipment.origin)}</span>
                            ${shipment.origin || 'N/A'}
                        </td>
                        <td>
                            <span class="flag-icon">${getCountryFlag(shipment.destination)}</span>
                            ${shipment.destination || 'N/A'}
                        </td>
                        <td>
                            <span class="status-badge ${getStatusClass(shipment.status)}">
                                ${shipment.status || 'Pending'}
                            </span>
                        </td>
                        <td>${formatDate(shipment.createdAt)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="showUpdateModal('${shipment.trackingNumber}')">
                                    <i class="fas fa-sync-alt"></i> Update
                                </button>
                                <button class="btn btn-success btn-sm" onclick="generateQRCodeForAdmin('${shipment.trackingNumber}', '${shipment.confirmationCode}')">
                                    <i class="fas fa-qrcode"></i> Generate QR
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteShipment('${shipment.trackingNumber}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    `;
                    shippingTableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading shipments:', error);
                shippingTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>Error loading shipments. Please refresh the page.</p>
                        </td>
                    </tr>
                `;
            }
        }

        // ==================== QR CODE GENERATION - FIXED ====================
        window.generateQRCodeForAdmin = function(trackingNumber, confirmationCode) {
            // Get website URL
            const websiteURL = getWebsiteURL();
            
            // Create the tracking URL
            const trackingURL = `${websiteURL}index.html?track=${trackingNumber}&code=${confirmationCode}`;
            
            console.log("üåê Generated QR Code URL:", trackingURL);
            
            // Create QR code modal
            const modalHTML = `
                <div id="adminQRModal" class="modal" style="display: block; z-index: 2000;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-qrcode"></i> QR Code for ${trackingNumber}</h2>
                            <span class="close" onclick="closeAdminQRModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="qr-code-container">
                                <div id="adminQRCode" class="qr-code-display"></div>
                                <div class="qr-info">
                                    <p><strong>Tracking Number:</strong> ${trackingNumber}</p>
                                    <p><strong>Confirmation Code:</strong> ${confirmationCode}</p>
                                    <p><strong>Scan this QR code to track shipment</strong></p>
                                    <p style="font-size: 12px; color: #666; margin-top: 10px; background: white; padding: 8px; border-radius: 5px; word-break: break-all;">
                                        URL: ${trackingURL}
                                    </p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="testTrackingLink('${trackingURL}')" style="flex: 1;">
                                    <i class="fas fa-external-link-alt"></i> Test Link
                                </button>
                                <button class="btn btn-success" onclick="downloadQRCode('${trackingNumber}')" style="flex: 1;">
                                    <i class="fas fa-download"></i> Download QR
                                </button>
                            </div>
                            <button class="btn btn-secondary" onclick="closeAdminQRModal()" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-times"></i> Close
                            </button>
                            <div style="margin-top: 15px; padding: 10px; background: #e8f4fc; border-radius: 8px;">
                                <p style="margin: 0; font-size: 13px; color: #2196F3;">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>Customer Instructions:</strong> 
                                    Scan this QR code with phone camera. It will open tracking page with auto-filled details.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Generate QR code
            setTimeout(() => {
                const qrElement = document.getElementById('adminQRCode');
                qrElement.innerHTML = '';
                
                // Generate QR code
                new QRCode(qrElement, {
                    text: trackingURL,
                    width: 180,
                    height: 180,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                console.log("‚úÖ QR Code generated successfully");
                
            }, 100);
        };

        // Test tracking link
        window.testTrackingLink = function(url) {
            window.open(url, '_blank');
            alert('‚úÖ Opening tracking page in new tab...\n\nIf page loads with auto-filled details, QR code is working!');
        };

        // Download QR code
        window.downloadQRCode = function(trackingNumber) {
            const qrElement = document.getElementById('adminQRCode');
            if (!qrElement) {
                alert("QR code not generated yet.");
                return;
            }
            
            const canvas = qrElement.querySelector('canvas');
            if (!canvas) {
                alert("Cannot download QR code. Please try again.");
                return;
            }
            
            const link = document.createElement('a');
            link.download = `SF-Shipping-${trackingNumber}-QR.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            alert(`‚úÖ QR code downloaded as: SF-Shipping-${trackingNumber}-QR.png`);
        };

        // Close admin QR modal
        window.closeAdminQRModal = function() {
            const modal = document.getElementById('adminQRModal');
            if (modal) {
                modal.remove();
            }
        };

        // Update shipment status (keep existing)
        window.showUpdateModal = async function(trackingNumber) {
            // ... existing update modal code ...
        };

        // Delete shipment (keep existing)
        window.deleteShipment = async function(trackingNumber) {
            // ... existing delete function ...
        };

        // Tab switching
        addShippingTab.addEventListener('click', () => {
            addShippingTab.classList.add('active');
            manageShippingTab.classList.remove('active');
            addShippingContent.classList.add('active');
            manageShippingContent.classList.remove('active');
        });

        manageShippingTab.addEventListener('click', () => {
            manageShippingTab.classList.add('active');
            addShippingTab.classList.remove('active');
            manageShippingContent.classList.add('active');
            addShippingContent.classList.remove('active');
            loadShipments();
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('sfAdminAuth');
            window.location.href = 'index.html';
        });

        // Initialize admin page
        if (shippingForm) {
            shippingForm.addEventListener('submit', addShipping);
        }
        
        // Load shipments if on manage tab
        if (manageShippingTab.classList.contains('active')) {
            loadShipments();
        }
        
        // Auto-refresh shipments every 30 seconds if on manage tab
        setInterval(() => {
            if (manageShippingTab && manageShippingTab.classList.contains('active')) {
                loadShipments();
            }
        }, 30000);

        // Close modals when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
    </script>
</body>
  </html>
